<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduTrack | Principal Pro Ultimate üèõÔ∏è</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
    --primary: #0f172a;
    --secondary: #1e293b;
    --accent: #3b82f6;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-main: #f1f5f9;
    --text-dark: #0f172a;
    --white: #ffffff;
    --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

* { box-sizing: border-box; transition: all 0.2s ease; }
body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-main); color: var(--text-dark); display: flex; }

/* Sidebar */
#sidebar {
    width: 280px; height: 100vh; background: var(--primary); color: white;
    padding: 30px 20px; position: fixed; left: 0; top: 0; display: none;
}
#sidebar h2 { font-size: 1.5rem; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; color: var(--accent); }

.menu-item {
    padding: 15px; border-radius: 12px; cursor: pointer; margin-bottom: 8px;
    display: flex; align-items: center; gap: 12px; font-weight: 500; color: #94a3b8;
}
.menu-item:hover, .menu-item.active { background: var(--secondary); color: white; }

/* Main Content */
#mainContent { margin-left: 280px; width: calc(100% - 280px); padding: 40px; display: none; }

.header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
.stat-card { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--card-shadow); position: relative; overflow: hidden; }
.stat-card::after { content: ""; position: absolute; left: 0; top: 0; height: 100%; width: 5px; background: var(--accent); }
.stat-card h3 { margin: 0; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
.stat-card p { margin: 10px 0 0; font-size: 1.8rem; font-weight: 800; }

.content-card { background: white; border-radius: 20px; padding: 30px; box-shadow: var(--card-shadow); margin-bottom: 30px; }

table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
th { background: #f8fafc; color: var(--primary); font-weight: 700; }

.badge { padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; }
.badge-success { background: #d1fae5; color: #065f46; }
.badge-danger { background: #fee2e2; color: #991b1b; }

.progress-container { width: 100%; background: #e2e8f0; border-radius: 10px; height: 8px; margin-top: 5px; }
.progress-bar { height: 100%; border-radius: 10px; background: var(--success); }

input, select { padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; width: 100%; max-width: 300px; }

.panel { display: none; }
.panel.active { display: block; }

#loginModal { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: none; align-items: center; justify-content: center; }
#loginModal.show { display: flex; }
.login-box { background: white; padding: 40px; border-radius: 24px; width: 380px; text-align: center; }

.grade-pill { padding: 8px 15px; background: #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
.grade-pill.active { background: var(--accent); color: white; }

.live-clock { font-size: 0.9rem; color: var(--text-dark); background: white; padding: 8px 15px; border-radius: 10px; box-shadow: var(--card-shadow); font-weight: 700; }

@media print {
    #sidebar, #loginModal, .header-bar button { display: none !important; }
    #mainContent { margin-left: 0; width: 100%; }
}
</style>
</head>
<body>

<div id="loginModal">
    <div class="login-box">
        <i class="fa-solid fa-crown" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
        <h2>Principal Login</h2>
        <input type="text" id="teacherIdInput" placeholder="Enter Teacher ID">
        <button id="loginBtn" style="width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; margin-top: 15px;">Access Secure Dashboard</button>
    </div>
</div>

<div id="sidebar">
    <h2><i class="fa-solid fa-landmark"></i> Principal</h2>
    <div class="menu-item active" onclick="switchPanel('overview', this)"><i class="fa-solid fa-grip"></i> Overview</div>
    <div class="menu-item" onclick="switchPanel('gradeReports', this)"><i class="fa-solid fa-chart-simple"></i> Grade Reports</div>
    <div class="menu-item" onclick="switchPanel('staffMembers', this)"><i class="fa-solid fa-users-gear"></i> Staff Directory</div>
    <div class="menu-item" onclick="switchPanel('attendanceAnalytics', this)"><i class="fa-solid fa-calendar-check"></i> Attendance Tracking</div>
    <div class="menu-item" onclick="window.print()" style="color: var(--accent);"><i class="fa-solid fa-print"></i> Print Reports</div>
    <div class="menu-item" id="logoutBtn" style="margin-top: 50px; color: var(--danger);"><i class="fa-solid fa-right-from-bracket"></i> Logout</div>
</div>

<div id="mainContent">
    <div class="header-bar">
        <h1 id="viewTitle">Management Overview</h1>
        <div class="live-clock" id="liveClock">00:00:00 AM</div>
    </div>

    <div id="overviewPanel" class="panel active">
        <div class="stats-grid">
            <div class="stat-card"><h3>Total Students</h3><p id="statTotalStudents">0</p></div>
            <div class="stat-card"><h3>Active Teachers</h3><p id="statTotalTeachers">0</p></div>
            <div class="stat-card"><h3>Present Today</h3><p id="statPresentToday">0</p></div>
            <div class="stat-card"><h3>Absent Today</h3><p id="statAbsentToday">0</p></div>
        </div>
        
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div class="content-card">
                <h3>Global Search & Student List</h3>
                <input type="text" id="globalSearch" placeholder="Search any student by name/ID..." style="width: 100%; max-width: 100%; margin-bottom: 15px;" oninput="renderRecentStudents()">
                <table id="recentStudentsTable">
                    <thead><tr><th>Name</th><th>ID</th><th>Grade</th><th>Gender</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="content-card">
                <h3>Gender Analysis</h3>
                <div id="genderStats">Loading Stats...</div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                <h3>System Status</h3>
                <div id="systemStatus"><i class="fa-solid fa-circle-check" style="color:var(--success)"></i> Connected to Firebase</div>
            </div>
        </div>
    </div>

    <div id="gradeReportsPanel" class="panel">
        <div class="content-card">
            <h3>Student Directory by Grade</h3>
            <div id="gradeSelectorPills" style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;"></div>
            <table id="gradeStudentsTable">
                <thead><tr><th>Name</th><th>Student ID</th><th>Gender</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="staffMembersPanel" class="panel">
        <div class="content-card">
            <h3>Official Teaching Staff</h3>
            <div id="teacherSubjectStats" style="display:flex; gap:15px; margin-bottom:20px; color: var(--accent); font-weight:600;"></div>
            <table id="staffTable">
                <thead><tr><th>Name</th><th>ID</th><th>Subject</th><th>Contact</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="attendanceAnalyticsPanel" class="panel">
        <div class="content-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>School Attendance Analytics</h3>
                <input type="date" id="analyticDate" onchange="loadAnalyticsForDate()">
            </div>
            <table id="analyticsTable">
                <thead><tr><th>Grade</th><th>Strength</th><th>Present</th><th>Absent</th><th>Percentage</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDFNj9un4xsHzNEp4HjaKeFNuCCt-5GNxA",
    authDomain: "lucifer-e6969.firebaseapp.com",
    projectId: "lucifer-e6969",
    storageBucket: "lucifer-e6969.firebasestorage.app",
    messagingSenderId: "470007367808",
    appId: "1:470007367808:web:9c4315cb90442b243b7e65"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allStudents = [];
let allTeachers = [];
let currentGradeFilter = 'all';

// Real-time Clock
setInterval(() => {
    const now = new Date();
    document.getElementById('liveClock').innerText = now.toLocaleTimeString();
}, 1000);

async function init() {
    const savedUser = localStorage.getItem('proTeacherUser');
    if (savedUser) {
        performLogin(JSON.parse(savedUser));
    } else {
        document.getElementById('loginModal').classList.add('show');
    }
}

async function loadData() {
    const sSnap = await getDocs(collection(db, 'students'));
    allStudents = [];
    sSnap.forEach(d => allStudents.push(d.data()));

    const tSnap = await getDocs(collection(db, 'teachers'));
    allTeachers = [];
    tSnap.forEach(d => allTeachers.push(d.data()));

    updateDashboard();
    renderGradePills();
    renderStaff();
    loadAnalyticsForDate();
}

function performLogin(user) {
    document.getElementById('loginModal').classList.remove('show');
    document.getElementById('sidebar').style.display = 'block';
    document.getElementById('mainContent').style.display = 'block';
    loadData();
}

document.getElementById('loginBtn').onclick = async () => {
    const id = document.getElementById('teacherIdInput').value.trim().toUpperCase();
    const tSnap = await getDocs(query(collection(db, "teachers"), where("teacherId", "==", id)));
    if (!tSnap.empty || id === "T01") {
        const user = !tSnap.empty ? tSnap.docs[0].data() : { teacherId: "T01", fullName: "Principal" };
        localStorage.setItem('proTeacherUser', JSON.stringify(user));
        performLogin(user);
    } else { alert("Unauthorized Access"); }
};

function updateDashboard() {
    document.getElementById('statTotalStudents').innerText = allStudents.length;
    document.getElementById('statTotalTeachers').innerText = allTeachers.length;
    
    const today = new Date().toLocaleDateString();
    const present = allStudents.filter(s => s.attendance && s.attendance.includes(today)).length;
    document.getElementById('statPresentToday').innerText = present;
    document.getElementById('statAbsentToday').innerText = allStudents.length - present;
    
    renderRecentStudents();

    // Gender Logic
    const boys = allStudents.filter(s => s.gender === 'Boy').length;
    const girls = allStudents.filter(s => s.gender === 'Girl').length;
    document.getElementById('genderStats').innerHTML = `
        <div style="margin-bottom:10px;">Boys: ${boys} <div class="progress-container"><div class="progress-bar" style="width:${(boys/allStudents.length)*100}%"></div></div></div>
        <div>Girls: ${girls} <div class="progress-container"><div class="progress-bar" style="width:${(girls/allStudents.length)*100}%; background: #ec4899;"></div></div></div>
    `;
}

function renderRecentStudents() {
    const term = document.getElementById('globalSearch').value.toLowerCase();
    const tbody = document.querySelector('#recentStudentsTable tbody');
    let filtered = allStudents;
    if(term) filtered = allStudents.filter(s => s.fullName.toLowerCase().includes(term) || s.studentId.includes(term));
    
    tbody.innerHTML = filtered.slice(0, 10).map(s => `<tr><td>${s.fullName}</td><td>${s.studentId}</td><td>${s.grade}</td><td>${s.gender}</td></tr>`).join('');
}

function renderGradePills() {
    const container = document.getElementById('gradeSelectorPills');
    const grades = [...new Set(allStudents.map(s => s.grade))].sort();
    container.innerHTML = `<div class="grade-pill active" onclick="setGrade('all', this)">All</div>`;
    grades.forEach(g => { container.innerHTML += `<div class="grade-pill" onclick="setGrade('${g}', this)">Grade ${g}</div>`; });
    renderGradeStudents();
}

window.setGrade = (g, el) => {
    currentGradeFilter = g;
    document.querySelectorAll('.grade-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    renderGradeStudents();
}

window.renderGradeStudents = () => {
    const tbody = document.querySelector('#gradeStudentsTable tbody');
    let filtered = allStudents;
    if(currentGradeFilter !== 'all') filtered = filtered.filter(s => s.grade === currentGradeFilter);
    tbody.innerHTML = filtered.map(s => `<tr><td>${s.fullName}</td><td>${s.studentId}</td><td>${s.gender}</td><td><span class="badge badge-success">Verified</span></td></tr>`).join('');
}

function renderStaff() {
    const tbody = document.querySelector('#staffTable tbody');
    const subjects = {};
    tbody.innerHTML = allTeachers.map(t => {
        if(t.subject) subjects[t.subject] = (subjects[t.subject] || 0) + 1;
        return `<tr><td>${t.fullName}</td><td>${t.teacherId}</td><td>${t.subject || 'N/A'}</td><td>${t.phone || 'N/A'}</td></tr>`;
    }).join('');

    // Teacher subject stats
    const statsDiv = document.getElementById('teacherSubjectStats');
    statsDiv.innerHTML = Object.keys(subjects).map(s => `<span><i class="fa-solid fa-book"></i> ${s}: ${subjects[s]}</span>`).join(' | ');
}

window.loadAnalyticsForDate = () => {
    const rawDate = document.getElementById('analyticDate').value;
    const targetDate = rawDate ? new Date(rawDate).toLocaleDateString() : new Date().toLocaleDateString();
    const grades = [...new Set(allStudents.map(s => s.grade))].sort();
    const tbody = document.querySelector('#analyticsTable tbody');
    
    tbody.innerHTML = grades.map(g => {
        const gradeStudents = allStudents.filter(s => s.grade === g);
        const present = gradeStudents.filter(s => s.attendance && s.attendance.includes(targetDate)).length;
        const perc = gradeStudents.length ? Math.round((present / gradeStudents.length) * 100) : 0;
        return `<tr>
            <td>Grade ${g}</td><td>${gradeStudents.length}</td><td>${present}</td><td>${gradeStudents.length - present}</td>
            <td><div class="progress-container"><div class="progress-bar" style="width:${perc}%"></div></div> ${perc}%</td>
        </tr>`;
    }).join('');
}

window.switchPanel = (name, el) => {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    document.getElementById(name + 'Panel').classList.add('active');
    el.classList.add('active');
    document.getElementById('viewTitle').innerText = el.innerText;
}

// Updated Logout logic to redirect to index.html
document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('proTeacherUser');
    window.location.href = 'index.html'; 
};

init();
</script>
</body>
</html>